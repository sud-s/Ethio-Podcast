<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ethiopodcasts - View All Podcasts</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background-color: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            text-align: center;
            margin-bottom: 30px;
        }
        .stats {
            display: flex;
            justify-content: space-around;
            margin-bottom: 30px;
            flex-wrap: wrap;
            gap: 10px;
        }
        .stat-box {
            background-color: #e3f2fd;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            min-width: 150px;
        }
        .stat-number {
            font-size: 24px;
            font-weight: bold;
            color: #1976d2;
        }
        .podcast-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        .podcast-card {
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            background-color: #fff;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            transition: transform 0.2s;
            display: flex;
            flex-direction: column;
        }
        .podcast-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        }
        .podcast-thumbnail {
            width: 100%;
            aspect-ratio: 16/9;
            object-fit: cover;
            border-radius: 6px;
            margin-bottom: 10px;
        }
        .podcast-info {
            flex: 1;
        }
        .podcast-title {
            font-weight: bold;
            margin-bottom: 8px;
            color: #333;
            font-size: 16px;
        }
        .podcast-uploader {
            color: #666;
            font-size: 14px;
            margin-bottom: 5px;
        }
        .podcast-category {
            display: inline-block;
            background-color: #e0e0e0;
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 12px;
            margin-bottom: 10px;
        }
        .podcast-duration {
            font-size: 12px;
            color: #666;
            margin-top: 5px;
        }
        .loading {
            text-align: center;
            padding: 40px;
            font-size: 18px;
            color: #666;
        }
        .error {
            text-align: center;
            padding: 40px;
            color: #f44336;
            font-size: 18px;
        }
        .controls {
            text-align: center;
            margin-bottom: 20px;
        }
        .play-btn {
            background-color: #4CAF50;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            margin-top: 10px;
            width: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        .play-btn:hover {
            background-color: #45a049;
        }
        .play-icon {
            font-size: 16px;
        }
        .pagination {
            text-align: center;
            margin-top: 30px;
        }
        .page-btn {
            background-color: #2196F3;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 4px;
            cursor: pointer;
            margin: 0 5px;
        }
        .page-btn:disabled {
            background-color: #bbdefb;
            cursor: not-allowed;
        }
        .btn {
            background-color: #4CAF50;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            margin: 0 5px;
        }
        .btn:hover {
            background-color: #45a049;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üéß Ethiopodcasts - All Podcasts</h1>
        
        <div class="controls">
            <button class="btn" onclick="loadPodcasts()">üîÑ Reload All Podcasts</button>
        </div>
        
        <div id="stats" class="stats">
            <div class="stat-box">
                <div class="stat-number" id="total-count">0</div>
                <div>Total Podcasts</div>
            </div>
            <div class="stat-box">
                <div class="stat-number" id="channel-count">0</div>
                <div>Channels</div>
            </div>
            <div class="stat-box">
                <div class="stat-number" id="tech-count">0</div>
                <div>Tech</div>
            </div>
            <div class="stat-box">
                <div class="stat-number" id="business-count">0</div>
                <div>Business</div>
            </div>
        </div>
        
        <div id="podcast-container">
            <div class="loading">Loading podcasts from YouTube channels...</div>
        </div>
        
        <div id="pagination" class="pagination" style="display:none;">
            <button class="page-btn" id="prev-btn" onclick="prevPage()" disabled>Previous</button>
            <span id="page-info"></span>
            <button class="page-btn" id="next-btn" onclick="nextPage()">Next</button>
        </div>
    </div>

    <script>
        const API_BASE = 'http://localhost:3000/api';
        let allPodcasts = [];
        let currentPage = 0;
        const podcastsPerPage = 12;
        
        // Format date for display
        function formatDate(dateString) {
            if (!dateString) return 'Unknown';
            const date = new Date(dateString);
            return date.toLocaleDateString();
        }
        
        // Calculate days difference
        function daysAgo(dateString) {
            if (!dateString) return 'Unknown';
            const date = new Date(dateString);
            const today = new Date();
            const diffTime = Math.abs(today - date);
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            return diffDays;
        }
        
        // Render podcasts to the page
        function renderPodcasts(podcasts) {
            const container = document.getElementById('podcast-container');
            
            if (podcasts.length === 0) {
                container.innerHTML = '<div class="error">No podcasts found</div>';
                return;
            }
            
            let html = '<div class="podcast-grid">';
            
            podcasts.forEach(podcast => {
                const days = daysAgo(podcast.created_at);
                let dateLabel = 'Unknown';
                if (days === 1) dateLabel = 'Today';
                else if (days === 2) dateLabel = 'Yesterday';
                else if (days < 7) dateLabel = `${days-1} days ago`;
                else dateLabel = formatDate(podcast.created_at);
                
                const thumbnail = podcast.thumbnail || `https://img.youtube.com/vi/${podcast.id}/mqdefault.jpg`;

                html += `
                <div class="podcast-card">
                    <img class="podcast-thumbnail" src="${thumbnail}" alt="${podcast.display_title || podcast.title}" onerror="this.src='https://img.youtube.com/vi/${podcast.id}/mqdefault.jpg'">
                    <div class="podcast-info">
                        <div class="podcast-title">${podcast.display_title || podcast.title}</div>
                        <div class="podcast-uploader"> ${podcast.uploader}</div>
                        <div class="podcast-category">üè∑Ô∏è ${podcast.category}</div>
                        <div class="podcast-uploader">üìÖ ${dateLabel}</div>
                    </div>
                    <button class="play-btn" onclick="openPlayer('${podcast.id}')">
                        <span class="play-icon"></span> Play Podcast
                    </button>
                </div>`;
            });
            
            html += '</div>';
            container.innerHTML = html;
        }
        
        // Update pagination controls
        function updatePagination() {
            const totalPages = Math.ceil(allPodcasts.length / podcastsPerPage);
            const startIndex = currentPage * podcastsPerPage;
            const endIndex = Math.min(startIndex + podcastsPerPage, allPodcasts.length);
            
            document.getElementById('page-info').textContent = 
                `Page ${currentPage + 1} of ${totalPages} (${startIndex + 1}-${endIndex} of ${allPodcasts.length})`;
            
            document.getElementById('prev-btn').disabled = currentPage === 0;
            document.getElementById('next-btn').disabled = endIndex >= allPodcasts.length;
            
            document.getElementById('pagination').style.display = 'block';
        }
        
        // Show current page of podcasts
        function showCurrentPage() {
            const startIndex = currentPage * podcastsPerPage;
            const endIndex = Math.min(startIndex + podcastsPerPage, allPodcasts.length);
            const currentPodcasts = allPodcasts.slice(startIndex, endIndex);
            
            renderPodcasts(currentPodcasts);
            updatePagination();
        }
        
        // Pagination functions
        function nextPage() {
            if ((currentPage + 1) * podcastsPerPage < allPodcasts.length) {
                currentPage++;
                showCurrentPage();
            }
        }
        
        function prevPage() {
            if (currentPage > 0) {
                currentPage--;
                showCurrentPage();
            }
        }
        
        // Update stats display
        function updateStats() {
            document.getElementById('total-count').textContent = allPodcasts.length;
            
            const techCount = allPodcasts.filter(p => p.category === 'Tech').length;
            const businessCount = allPodcasts.filter(p => p.category === 'Business').length;
            
            document.getElementById('tech-count').textContent = techCount;
            document.getElementById('business-count').textContent = businessCount;
            
            // Count unique channels
            const channels = [...new Set(allPodcasts.map(p => p.uploader))];
            document.getElementById('channel-count').textContent = channels.length;
        }
        
        // Load all podcasts from Firestore
        async function loadPodcasts() {
            try {
                document.getElementById('podcast-container').innerHTML = 
                    '<div class="loading">Loading podcasts from database...</div>';
                
                // Load all podcasts (use large limit to get all)
                const response = await fetch(`${API_BASE}/discover?limit=1000`);
                const result = await response.json();
                
                if (result.status !== 'success') {
                    throw new Error(result.message || 'Failed to fetch podcasts');
                }
                
                allPodcasts = result.data.podcasts || [];
                currentPage = 0;
                
                updateStats();
                showCurrentPage();
            } catch (error) {
                document.getElementById('podcast-container').innerHTML = 
                    `<div class="error">Error: ${error.message}<br><br>Run: python scrape_all_podcasts.py</div>`;
            }
        }
        
        // Open player for a podcast
        function openPlayer(podcastId) {
            window.open(`audio-player.html?id=${podcastId}&autoplay=true`, '_blank', 'width=600,height=800');
        }
        
        // Load data when page loads
        window.onload = function() {
            loadPodcasts();
        };
    </script>
</body>
</html>
